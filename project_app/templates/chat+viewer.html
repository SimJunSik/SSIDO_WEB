<!DOCTYPE html>
<html>
<head>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>


	<title></title>
	<script type="text/javascript">
		function startFS() {
			var element = document.getElementById("viewer_content");
			if(element.requestFullScreen) {
				element.requestFullScreen();
			} else if(element.webkitRequestFullScreen ) {
				element.webkitRequestFullScreen();
			} else if(element.mozRequestFullScreen) {
				element.mozRequestFullScreen();
			} else if (element.msRequestFullscreen) {
				element.msRequestFullscreen(); // IE
			}
		}
	</script>
	

	<script type="text/javascript" src="http://code.jquery.com/jquery-1.12.4.min.js"></script>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>  
	<script type="text/javascript" src="../static/js/pdfobject.js"></script>

	<style type="text/css">
		.top{
			width: 100%;
			height: 5vw;
			background-color: white;
			position: fixed;
			top: 0;
			z-index: 9998;
		}
		.top_login_div, .top_login_member_div{
			width: 20vw;
			height: 80%;
			margin-top: 0.5%;
			float: right;
			position: relative;
		}

		.middle{
			width: 100%; 
			height: 90%;
			position: absolute;
			top: 5vw;
		}


		.chat_body{
			width: 100%;
			height: 100%;
			background-color: #EAEAEA;
			border: 1px solid transparent;
   			border-radius: 10px;
		}
		.best_chat{
			width: 95%;
			height: 25%;
			margin-bottom: 5%;
			margin-left: 2.5%;
			overflow-y : scroll;
			overflow-x: hidden;
			border: 1px solid black;
   			border-radius: 10px;
		}
		.chat_show{
			width: 95%;
			height: 60%;
			margin-left: 2.5%;
			background-color: transparent;
			overflow-y : scroll;
			overflow-x: hidden;
		}
		.chat_input_div{
			width: 95%;
			height: 10%;
			background-color: transparent;
		}
		.chat_div{
			width: 100%;
			height: 15%;
			background-color: transparent;
			border: 1px solid transparent;
   			border-radius: 10px;
		}
		.chat_content_div{
			width: 65%;
			height: 100%;
			margin-bottom: 0.5vw;
			border: 1px solid transparent;
   			border-radius: 10px;
		}
		#send_msg_btn{
			background-color: #F2385A;
		    border: none;
		    color: white;
		    padding: 20px;
		    text-align: center;
		    text-decoration: none;
		    display: inline-block;
		    font-size: 16px;
		    margin: 4px 2px;
		    cursor: pointer;
		    border-radius: 30px;
		}
		.set_user_name_div{
			width: 100%;
			height: 5%;
			background-color: yellow;
		}
		.center_div{
			width: 60%;
			height: 50%;
			margin-left: 5%;
			float: left; 
		}
		.memo_div{
			width: 60%;
			height: 94%;
			margin-top: 1%;
			margin-bottom: 1%;
			margin-left: 5%;
			border: 1px solid transparent;
   			border-radius: 10px;
			background-color: white;
			float: left;
		}
		.user_list_div{
			width: 100%;
			height: 10%;
			background-color: green;
		}
		input{
			all : unset;
		}
	</style>


	<style type="text/css">
		#viewer_div{
			width: 100%;
			height: 30vw;
		}
		#viewer_content{
			width: 100%;
			height: 90%;
		}
		.pdfobject-container { 
			height: 30rem; 
			border: 1rem solid rgba(0,0,0,.1); 
		}
	</style>
</head>
<body style="height: 1500px; background-color: white; width: 100%; margin: 0; position: relative;">

	<div class="top">
		<img src="../../static/img/logo3.png" style="width: 10vw; height: 80%; float: left; margin-left: 5%; margin-top: 0.5%;">
			{% if member.user_id == 'unknown' %}
			<div class="top_login_div">
				<!--
				<input type="text" id="id_input" style="width: 5vw; height: 80%;" placeholder="ID">
				<input type="text" id="psw_input" style="width: 5vw; height: 80%;" placeholder="PSW">
				<button class="login_button" style="width: 5vw; height: 80%; background-color: transparent; color: black;" onclick="login();">
					로그인
				</button>
				-->
				<button class="login_button" style="width: 5vw; height: 80%; background-color: transparent; color: black;" onclick="loginShow();">
					로그인
				</button>
				<button class="register_button" style="width: 10vw; height: 80%;" onclick="go_join_page();">
					회원가입
				</button>
			</div>
			{% else %}
			<div class="top_login_member_div">
				<div class="top_hello_div" style="width: 100%; height: 50%; float: right;">
					<a href="../../logout/">{{member.user_name}}</a>님 안녕하세요.
				</div>

				<div class="top_member_button_div" style="width: 100%; height: 50%;">
					<button class="create_class_button" style="width: 7vw; height: 80%; background-color: transparent; color: black;" onclick="classShow();">
						클래스 개설
					</button>
					<button class="mypage_button" style="width: 7vw; height: 80%; background-color: transparent; color: black;">
						마이페이지
					</button>
				</div>
			</div>
			{% endif %}
	</div>

	<div class="middle">
		<div class="class_title_div" style="width: 90%; height: 10%; margin-left: 5%; position: relative;">
			<div class="class_title_content" style="width: auto; height: auto; font-size: 3vw; position: absolute; top: 50%; transform: translate(0%,-50%);">
				클래스 이름
			</div>
		</div>
		<div class="center_div">
			<div id="viewer_div">
				<div id="viewer_content">

				</div>
				<img src="../static/img/full_screen_icon.png" style="width: 1vw; height: 1vw; float: right;" onclick="startFS();"> 
				<!--
				<button type="button" style="width: 20px; height: 20px; background-image: url(../static/img/like_icon.png);" onclick="startFS();">[]</button>
				-->
			</div>
			<!--
			<div class="memo_div">
				<input type="textarea" style="width: 100%; height: 100%;">
			</div>
			-->
			<div class="function_div" style="width: 100%; height: 50%; background-color: #D5D5D5; border: 1px solid transparent;
	   			border-radius: 10px;">
				<div class="pdf_div"  style="width: 30%; height: 95%; float: left; background-color: white; border: 1px solid transparent; border-radius: 10px; margin-top: 1%;">
					<div class="pdf_list_div" style="width: 100%; height: 80%; background-color: white;">
						{% for pdf in pdfs %}
							<div id="{{pdf.pdf.url}}" class="pdf_content" style="width: 100%; height: 10%; background-color: transparent; border: 1px solid transparent; border-radius: 10px;" onclick="change_pdf(this);">
								{{pdf.pdf_name}}
							</div>
						{% endfor %}
					</div>

					<div class="upload_pdf_div">
						<form action="" method="post" enctype="multipart/form-data" name="frm">
							{% csrf_token %}
					        <input type="file" id="pdfs" value="" name="upload[]" multiple>
					        <button type="button" value="업로드" onclick="check_file_and_submit();">업로드</button>
					    </form>
					    <div id="selected_pdfs" style="font-size: 10px;">

					    </div>
					</div>
				</div>


				<div class="memo_div">
					<div class="memo_title" style="width: 100%; height: 15%; font-size: 2vw;">
						MEMO
					</div>
					<input type="textarea" style="width: 100%; height: 85%;">
				</div>
			</div>
		</div>




		<div class="chat_div" style="width: 25%; height: 60%; float: left; margin-left: 5%; border: 1px solid transparent;
	   border-radius: 10px;">
	   		<!--
			<div class="user_list_div">

			</div>
			-->
			<div class="chat_body">
				<div class="best_chat" id="best_chat_id">
				
				</div>
				<div class="chat_show" id="chat_show_id">
					
				</div>
				<div class="chat_input_div" style="position: relative; margin-top: 5%;">
					<input type="text" id="chat_input" style="width: 16vw; height: 3vw; background-color: white; float: left; border: 1px solid transparent; border-radius: 10px; margin-right: 5%; margin-left: 2%; margin-top: 0.5%;">
					<button id="send_msg_btn" type="button" style="width: 5vw; height: 3vw; float: left;" onclick="send_msg();">보내기</button>
				</div>
			</div>

			<!--
			<div class="set_user_name_div" style="position: relative;">
				<input type="text" id="user_id_input" style="width: 70%; height: 90%; background-color: white; float: left;">
				<button type="button" style="width: 25%; height: 90%; float: left;" onclick="set_user_id();">ID SET</button>
			</div>

			<div class="set_user_name_div" style="position: relative;">
				<input type="text" id="user_name_input" style="width: 70%; height: 90%; background-color: white; float: left;">
				<button type="button" style="width: 25%; height: 90%; float: left;" onclick="set_user_name();">NAME SET</button>
			</div>

			<div class="set_user_name_div" style="position: relative;">
				<input type="text" id="class_id_input" style="width: 70%; height: 90%; background-color: white; float: left;">
				<button type="button" style="width: 25%; height: 90%; float: left;" onclick="set_class_id();">CLASS SET</button>
			</div>
			-->
		</div>
	</div>

	<input type="text" name="class_id_text" id="class_id_text" value="{{class_id}}" hidden="hidden">
	<input type="text" id="global_user_id_value" value="{{member.user_id}}" hidden="hidden">
	<input type="text" id="user_name_value" value="{{member.user_name}}" hidden="hidden">

	<script>
		//Be sure your document contains an element with the CSS selector "test_div"
		PDFObject.embed("", "#viewer_content");
	</script>
	<script type="text/javascript">
		var href_split = window.location.href.split('/');
		//alert(window.location.href.split('/')[window.location.href.split('/').length-1]);

		var global_user_id = $("#global_user_id_value").val();
		var user_name = $("#user_name_value").val();
		var global_class_id = href_split[href_split.length-1];
		var best_chat_min_ddabong = 5;
		var upload_ok = 'true';

		//alert(global_user_id);
		//alert(user_name);

	    $(document).ready(function(){
	      	updateData();

	      	$("#pdfs").change(function () {
	        	//alert(document.getElementById('pdfs').files.length);
	        	var file_length = document.getElementById('pdfs').files.length;
	        	var file_list = '';
	        	var is_not_pdf_file = 'false';
	        	for(var i=0;i<file_length;i++){
	                var pdfs = document.getElementById('pdfs').files[i].name;
	                //alert(pdfs.split('.')[pdfs.split('.').length-1]);
	                var file_format = pdfs.split('.')[pdfs.split('.').length-1];
	                var color = 'black';
	                if(file_format != 'pdf'){
		                color = 'red';
		                is_not_pdf_file = 'true';
		            }
		            file_list += "<p style=\"color:" + color + ";\">" + (i+1) + " : " + pdfs + '<br>';
	            }
	            $("#selected_pdfs").html(file_list);
	            if(is_not_pdf_file == 'true'){
	            	alert("pdf 파일만 업로드 가능합니다.");
	            	upload_ok = 'false';
	            }
	            else {
	            	upload_ok = 'true';
	            }
	        });

	      	$("#class_id_text").val(global_class_id);
	    });

	    function updateData(){
	    	var content_list = [];
	    	var name_list = [];
	    	var date_list = [];
	    	var class_id_list = [];
	    	var pk_list = [];
	    	var ddabong_list = [];
	    	var user_id_list = [];

	        $.ajax({
	          url: '/updateChat/',
	          data: {
	          	  "class_id" : global_class_id
	          },
	          dataType: 'json',
	          success: function (data) {
	            //alert(data.chats);
	            var chat = data.chats;
	            var chat_tmp = chat;
	            //alert(data.length);
	            while(chat_tmp.length >0){
		            var content_idx = chat_tmp.indexOf("content");
		            if(content_idx == -1){
		            	break;
		            }
		            var content_sub = chat_tmp.substring(content_idx+11, chat_tmp.length);

		            var comma_idx = content_sub.indexOf("\"");
		            var content = content_sub.substring(0,comma_idx);
		            //alert(content);
		            if(content.length > 0){
		            	content_list.push(content);
		            }
		            chat_tmp = content_sub;
		        }

		        chat_tmp = chat;

		        while(chat_tmp.length >0){
		            var name_idx = chat_tmp.indexOf("user_name");
		            //alert(name_idx);
		            if(name_idx == -1){
		            	break;
		            }
		            var name_sub = chat_tmp.substring(name_idx+13, chat_tmp.length);

		            var comma_idx = name_sub.indexOf("\"");
		            var name = name_sub.substring(0,comma_idx);
		            //alert(name_sub);
		            if(name.length > 0){
		            	name_list.push(name);
		            }
		            chat_tmp = name_sub;
		        }

		        chat_tmp = chat;

		        while(chat_tmp.length >0){
		            var date_idx = chat_tmp.indexOf("created_date");
		            //alert(name_idx);
		            if(date_idx == -1){
		            	break;
		            }
		            var date_sub = chat_tmp.substring(date_idx+16, chat_tmp.length);

		            var comma_idx = date_sub.indexOf("\"");
		            var date = date_sub.substring(0,comma_idx);
		            //alert(name_sub);
		            if(date.length > 0){
		            	date_list.push(date);
		            }
		            chat_tmp = date_sub;
		        }

		        chat_tmp = chat;

		        while(chat_tmp.length >0){
		            var class_id_idx = chat_tmp.indexOf("class_id");
		            //alert(name_idx);
		            if(class_id_idx == -1){
		            	break;
		            }
		            var class_id_sub = chat_tmp.substring(class_id_idx+12, chat_tmp.length);

		            var comma_idx = class_id_sub.indexOf("\"");
		            var class_id = class_id_sub.substring(0,comma_idx);
		            //alert(name_sub);
		            if(class_id.length > 0){
		            	class_id_list.push(class_id);
		            }
		            chat_tmp = class_id_sub;
		        }

		        chat_tmp = chat;

		        while(chat_tmp.length >0){
		            var pk_idx = chat_tmp.indexOf("chat_unique_id");
		            //alert(name_idx);
		            if(pk_idx == -1){
		            	break;
		            }
		            var pk_sub = chat_tmp.substring(pk_idx+18, chat_tmp.length);

		            var comma_idx = pk_sub.indexOf("\"");
		            var pk = pk_sub.substring(0,comma_idx);
		            //alert(name_sub);
		            if(pk.length > 0){
		            	pk_list.push(pk);
		            }
		            chat_tmp = pk_sub;
		        }

		        chat_tmp = chat;

		        while(chat_tmp.length >0){
		        	//alert(chat_tmp);
		            var ddabong_idx = chat_tmp.indexOf("ddabong");
		            //alert(name_idx);
		            if(ddabong_idx == -1){
		            	break;
		            }
		            var ddabong_sub = chat_tmp.substring(ddabong_idx+10, chat_tmp.length);

		            var comma_idx = ddabong_sub.indexOf("}");
		            var ddabong = ddabong_sub.substring(0,comma_idx);
		            //alert(ddabong);
		            if(ddabong.length > 0){
		            	ddabong_list.push(ddabong);
		            }
		            chat_tmp = ddabong_sub;
		        }


		        chat_tmp = chat;

		        while(chat_tmp.length >0){
		        	//alert(chat_tmp);
		            var user_id_idx = chat_tmp.indexOf("user_id");
		            //alert(name_idx);
		            if(user_id_idx == -1){
		            	break;
		            }
		            var user_id_sub = chat_tmp.substring(user_id_idx+11, chat_tmp.length);

		            var comma_idx = user_id_sub.indexOf("\"");
		            var user_id = user_id_sub.substring(0,comma_idx);
		            //alert(ddabong);
		            if(user_id.length > 0){
		            	user_id_list.push(user_id);
		            }
		            chat_tmp = user_id_sub;
		        }

		        //alert(user_id_list);

		        var chat_content = '';
		        var best_chat_content = '';
		        for(var i=0;i<content_list.length;i++){
		        	//alert(class_id_list[i]);
		        	if(global_class_id == class_id_list[i]){
			            var start = "<div class=\"chat_div\">";
			            var content_start = "<div class=\"chat_content_div\" style=\"background-color: #A6A6A6;float: left;\">";
			            
			            var chat_content_body = name_list[i] + " : " + content_list[i] + "<br><br>";
			            
			            var chat_ddabong1 = "<img src=\"../static/img/like_icon.png\" id=\"";
			            var chat_ddabong_id = class_id_list[i] + "$$$" + name_list[i] + "$$$" + content_list[i] + "$$$" + date_list[i];
			            var chat_ddabong2 = "\" style=\"width: 1vw; height:1vw;\" onclick=\"ddabong(this);\">";
			            var ddabong_cnt = ddabong_list[i];
			            
			            var chat_delete1 = "<img src=\"../static/img/delete_icon.png\" id=\"";
			            var chat_delete_id = class_id_list[i] + "%%%" + name_list[i] + "%%%" + content_list[i] + "%%%" + date_list[i];
			            var chat_delete2 = "\" style=\"width: 1vw; height:1vw; margin-left: 1%;\" onclick=\"delete_msg(this);\">";

			            
			            var content_end = "</div>";

			            var end = "</div>";

			            var chat_ddabong = chat_ddabong1 + chat_ddabong_id + chat_ddabong2 + ddabong_cnt;
			            var chat_delete = chat_delete1 + chat_delete_id + chat_delete2;

			            //alert(user_id);

			            // 본인 채팅에만 삭제버튼 추가
			            if(global_user_id == user_id_list[i]){
			            	content_start = "<div class=\"chat_content_div\" style=\"background-color: #D5D5D5;float: right;\">";
				            chat_content += start + content_start + chat_content_body + chat_ddabong + chat_delete + content_end + end;
				        }
				        else{
				        	chat_content += start + content_start + chat_content_body + chat_ddabong + content_end + end;
				        }

				        // 좋아요 갯수 best_chat_min_ddabong 개 이상만 BEST CHAT에 등록
				        if(ddabong_list[i] >= best_chat_min_ddabong){
				        	start = "<div class=\"chat_div\" style=\"height: 35%;\">";
				        	if(global_user_id == user_id_list[i]){
				            	best_chat_content += start + content_start + chat_content_body + chat_ddabong + chat_delete + content_end + end;
					        }
					        else{
					        	best_chat_content += start + content_start + chat_content_body + chat_ddabong + content_end + end;
					        }
				        }
				    }
		        }


	            $("#chat_show_id").html(chat_content);
	            $("#best_chat_id").html(best_chat_content);
	          }
	        });
	        setTimeout("updateData()",1000);
	    }

	    function send_msg(){
	    	var chat_content = $("#chat_input").val();
	        $.ajax({
	          url: '/sendChat/',
	          data: {
	          	  'user_id' : global_user_id,
	          	  'user_name' : user_name,
	          	  'chat_content' : chat_content,
	          	  'class_id' : global_class_id,
	          },
	          dataType: 'json',
	          success: function (data) {
	          	$("#chat_input").val("");
	            //alert("!!!!");
	          }
	        });
	    }




	    function set_user_id(){
	    	var user_id_tmp = $("#user_id_input").val();
	    	global_user_id = user_id_tmp;
	    	alert("user id ok");
	    }

	    function set_user_name(){
	    	var user_name_tmp = $("#user_name_input").val();
	    	user_name = user_name_tmp;
	    	alert("user name ok");
	    }

	    function set_class_id(){
	    	var class_id_tmp = $("#class_id_input").val();
	    	global_class_id = class_id_tmp;
	    	alert("class id ok");
	    }







	    function ddabong(btn){
	    	//alert(btn.id);
	    	var btn_id = btn.id;
	    	var btn_id_split = btn_id.split("$$$");
	    	//alert(btn_id_split);
	    	$.ajax({
	          url: '/ddabong/',
	          data: {
	          	  'class_id' : btn_id_split[0],
	          	  'user_name' : btn_id_split[1],
	          	  'content' : btn_id_split[2],
	          	  'date' : btn_id_split[3]
	          },
	          dataType: 'json',
	          success: function (data) {
	          	$("#chat_input").val("");
	            //alert("!!!!");
	          }
	        });
	    }





	    function delete_msg(btn){
	    	var btn_id = btn.id;
	    	var btn_id_split = btn_id.split("%%%");

	    	$.ajax({
	          url: '/delete_msg/',
	          data: {
	          	  'class_id' : btn_id_split[0],
	          	  'user_name' : btn_id_split[1],
	          	  'content' : btn_id_split[2],
	          	  'date' : btn_id_split[3]
	          },
	          dataType: 'json',
	          success: function (data) {
	          	$("#chat_input").val("");
	            //alert("!!!!");
	          }
	        });
	    }


	    function change_pdf(pdf){
	    	var pdf_url = pdf.id;
	    	$(".pdf_content").css('background-color','transparent');
	    	PDFObject.embed(pdf_url, "#viewer_content");
	    	pdf.style.backgroundColor = '#F2385A';
	    }

        function check_file_and_submit(){
        	var file_length = document.getElementById('pdfs').files.length;
        	if(file_length == 0){
        		alert("파일을 선택해주세요.");
        	}
        	else if(upload_ok == 'true'){
	        	var p = document.frm;
	        	p.action = "../joinClass/" + global_class_id;
	            p.submit();
	        }
	        else if(upload_ok == 'false'){
	        	alert("pdf 파일만 업로드 가능합니다.");
	        }
        }
	    
	</script>
</body>
</html>